generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////////////////////////////////////////
// ENUMS
///////////////////////////////////////////////////////////

enum DiscountState {
  POOL
  ACTIVE
  REDEEMED
  VOID
}

enum ReferralEventType {
  IMPRESSION
  CLICK
  ACTIVATE
  REDEEM
}

///////////////////////////////////////////////////////////
// SHOP & SETTINGS
///////////////////////////////////////////////////////////

model Shop {
  id            String   @id @default(cuid())
  shopDomain    String   @unique
  accessToken   String?
  scope         String?
  installed     Boolean  @default(true)
  active        Boolean  @default(true)
  installedAt   DateTime @default(now())
  uninstalledAt DateTime?

  settings      ShopSettings?
  categories    BrandCategorySelection[]
  friendly      FriendlyBrand[]
  discountCodes DiscountCode[]
  referralFrom  ReferralEvent[] @relation("ReferralFrom")
  referralTo    ReferralEvent[] @relation("ReferralTo")
  commissions   CommissionLedger[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ShopSettings {
  id                 String   @id @default(cuid())
  shopId             String   @unique
  shop               Shop     @relation(fields: [shopId], references: [id])

  discountValue      Decimal  // e.g. 0.10
  expiryDays         Int
  maxDiscounts       Int
  oneTimeUse         Boolean  @default(true)

  allowedCountries   String[]
  allowedMemberTypes String[]

  collectionGids     String[]

  commissionRate     Decimal  // NOT editable in merchant UI

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

///////////////////////////////////////////////////////////
// BRAND CATEGORISATION
///////////////////////////////////////////////////////////

model BrandCategorySelection {
  id         String @id @default(cuid())
  shopId     String
  shop       Shop   @relation(fields: [shopId], references: [id])

  categoryId String  // from fixed taxonomy

  createdAt  DateTime @default(now())

  @@unique([shopId, categoryId])
}

///////////////////////////////////////////////////////////
// FRIENDLY BRANDS (EDITORIAL PREFERENCE)
///////////////////////////////////////////////////////////

model FriendlyBrand {
  id            String   @id @default(cuid())
  shopId        String
  shop          Shop     @relation(fields: [shopId], references: [id])

  targetShopId  String?
  targetUrl     String?

  createdAt     DateTime @default(now())
}

///////////////////////////////////////////////////////////
// DISCOUNT CODES (CORE ECONOMIC UNIT)
///////////////////////////////////////////////////////////

model DiscountCode {
  id                    String        @id @default(cuid())
  toShopId              String
  toShop                Shop          @relation(fields: [toShopId], references: [id])

  code                  String        @unique
  shopifyDiscountGid    String?

  state                 DiscountState @default(POOL)

  startsAt              DateTime?
  endsAt                DateTime?

  activatedAt           DateTime?
  redeemedAt            DateTime?

  orderId               String?       @unique
  orderAmount           Decimal?
  lineItemCount         Int?

  referralEvents        ReferralEvent[] 

  createdAt             DateTime @default(now())
}

///////////////////////////////////////////////////////////
// REFERRAL EVENTS (LEARNING SIGNALS)
///////////////////////////////////////////////////////////

model ReferralEvent {
  id            String             @id @default(cuid())

  fromShopId    String
  fromShop      Shop               @relation("ReferralFrom", fields: [fromShopId], references: [id])

  toShopId      String
  toShop        Shop               @relation("ReferralTo", fields: [toShopId], references: [id])

  discountCodeId String?
  discountCode   DiscountCode?     @relation(fields: [discountCodeId], references: [id])

  type          ReferralEventType
  meta          Json?

  timestamp     DateTime @default(now())
}

///////////////////////////////////////////////////////////
// COMMISSION (RECIP REVENUE)
///////////////////////////////////////////////////////////

model CommissionLedger {
  id                String   @id @default(cuid())
  shopId            String
  shop              Shop     @relation(fields: [shopId], references: [id])

  orderId           String   @unique
  orderAmount       Decimal

  commissionRate    Decimal
  commissionAmount  Decimal

  periodMonth       String   // YYYY-MM
  billedAt          DateTime?

  createdAt         DateTime @default(now())
}

///////////////////////////////////////////////////////////
// ===================== V2 ==============================
// LEARNING / AGGREGATES (NOT DEPLOYED IN V1)
///////////////////////////////////////////////////////////

/*
model BrandDailyStats {
  id                   String   @id @default(cuid())
  toShopId             String
  date                 DateTime // UTC date

  impressions          Int
  clicks               Int
  activations          Int
  redemptions          Int

  ordersCount          Int
  totalOrderValue      Decimal
  totalLineItemCount   Int

  createdAt            DateTime @default(now())

  @@unique([toShopId, date])
}
*/